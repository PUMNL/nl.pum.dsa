nl.pum.dsa
==========

Extension for DSA implementation at PUM Netherlands senior experts

Adds case activity type "DSA". Make sure to link the DSA activity to your cases in your case management xml files.
Adds option group "DSA Percentage" (name "dsa_percentage"), containing "0%" (value 0), "20%" (value 20) and "100%" (value 100).
Adds additional activity status "Payable" (name "dsa_payable") and "Paid" ("dsa_paid").

Adds 5 tables
- civicrm_dsa_convert
- civicrm_dsa_batch
- civicrm_dsa_rate
- civicrm_country_pum
- civicrm_dsa_compose
- civicrm_dsa_payment (update 1003)

Adds "DSA" submenu under "Administer" menu
DSA submenu contains 3 buttons for DSA-rate control
- Convert UN files to CSV 
- Import locations and rates
- View imported batches

Adds a page "DSAimport"
This page can be called using ?action=convert, upload, result or read:

Adds following option groups:
- "dsa_percentage" (names/values non-critical),
- "general_ledger" (names for the values are mandatory in the code) and
- "dsa_configuration" (names for the values are mandatory in the code)
Please review these added option values anter install / upgrade

Adds additional actiovity statusses to option_group "activity_status":
- "dsa_payable" (name is mandatory in the code)
- "dsa_paid" (name is mandatory in the code)


"convert"
imports the original UN locations and rates files (country in ICSC format, rate in USD) into civicrm_dsa_convert and
presents the data as CSV in a return field (country in ISO2 format, rate in USD)
country conversion is based on civicrm_country_pum

"import"
imports filtered/converted/reviewed CSV (country in ISO2 format, rate in EUR) as a batch into civicrm_dsa_batch and civicrm_dsa_rate

"result"
acts as handler and return screen after submitting "convert" or "import" data

"read"
displays imported DSA batches (maintenance not implemented yet)

Adds a set of additional fields to the activity "DSA". These are not "custom fields" as known in CiciCRM.
This set of fields is stored in civicrm_dsa_compose. If present, the field "original_id" in the case is used to tie the fields to the case, otherwise the case' id is used.

A user is offered to add a DSA activity (if defined in xml).
On the activity the user is supposes to select a participant (implicit selection of payment type and participant role).
Only one DSA activity per participant (!) will be allowed in any status other than 'dsa_paid', 'Cancelled' or 'Not Required'.
Once processed (status is automatically set to 'dsa_paid', another DSA activity can be made for creditation of the very same amounts.
If multiple DSA activities are being edited into a state that would lead to having more than one 'open' DSA activity, for a single participant, validation will block the ones causing a violation.


== WARNING =========================================================================================================
Extension relies on custom fields, generated by nl.pum.generic
2 Of these fields (Bank ISO Country code and Accountholder country) appeared useless
The current code assumes presence of Bank Country ISO code and Account holder country as country selection fields
Please adjust line 200 and 208 if put to use before the fields have been properly implemented
====================================================================================================================


** TO DO **
* test install process
* scheduled export of DSA activities / promotion to status "dsa_paid"
* control feature to export only on certain days on/after a specified date
* white overlay screens for activity, status change etc.
* batch management (filling out start- / end dates)
* disable move to case, copy to case, delete / conditional disabling edit.
* maintenance option for civicrm_pum_country: create / remove / edit additional country info (unless fully replaced by a country card feature)
* amount overviews (screen, B.I. purposes?)
* payment overview per expert (mail)
* payment overview per payment run (mail)
* fill out missing columns (e.g. account number, account holder details, bank details, 'FactuurNumberYear')
* auto-creation of a scheduled job to trigger ProcessPayment. Currently we rely on manual creation / manual trigger
***


Additional notes:
As of release 1008, the term "outfit allowance" is no longer used and replaced my "medical" expense. However, general ledger code "gl_outfit" is still in use for that purpose (in both the API "DSA/ProcessPayment" and installation script "dsa.optiongroup.inc.php")
As of version 1.1, the extension relies on the permisions CiviCRM DSA create/edit/approve DSA activity


KNOWN ISSUES:
Expected upload directory: <site root>/upload (like <site root>/modules)
Any errors raised in ProcessPayment are displayed on the screen, using dpm() (drupal: Devel module).
